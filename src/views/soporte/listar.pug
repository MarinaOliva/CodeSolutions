extends ../layouts/main

block contenido
  if notificacion && notificacion.trim() !== ""
    script.
      alert("#{notificacion}");
      const url = new URL(window.location);
      url.searchParams.delete('notificacion');
      window.history.replaceState({}, document.title, url);

  .d-flex.justify-content-between.align-items-center.mb-3
    h1 Tickets de Soporte
    a.btn.btn-primary(href='/soporte/crear') Nuevo Ticket

  .card.shadow-sm
    .card-body
      if tickets && tickets.length > 0
        .table-responsive
          table.table.table-hover.table-striped.align-middle
            thead.table-light
              tr
                th Título
                th Estado
                th Tipo
                th.text-end Acciones
            tbody
              each ticket in tickets
                tr
                  td= ticket.titulo
                  td
                    if ticket.estado === 'En progreso'
                      span.badge.bg-primary= ticket.estado
                    else if ticket.estado === 'Derivado'
                      span.badge.bg-warning.text-dark= ticket.estado
                    else if ticket.estado === 'Solucionado'
                      span.badge.bg-success= ticket.estado
                    else
                      span.badge.bg-secondary= ticket.estado
                  td= ticket.tipo
                  td.text-end
                    .btn-group(role="group")
                      button.expand-btn.btn.btn-sm.btn-outline-info(data-id=ticket._id) Detalles
                      a.btn.btn-sm.btn-outline-warning(href=`/soporte/${ticket._id}/editar`) Editar
                      form(action=`/soporte/${ticket._id}/borrar`, method="POST", style="display:inline")
                      button.btn.btn-sm.btn-danger(
                        type="submit",
                        onclick="return confirm('¿Está seguro de que deseas borrar este ticket?')"
                      ) Borrar

                tr.detalle(id='detalle-' + ticket._id, style="display:none")
                  td.bg-light-subtle(colspan="4")
                    p #[strong Descripción:] #{ticket.descripcion || '-'}
                    p #[strong Cliente:] #{ticket.cliente || '-'}
                    p #[strong Fecha de creación:] #{ticket.fechaCreacion ? new Date(ticket.fechaCreacion).toLocaleDateString() : '-'}
                    p #[strong Fecha de cierre:] #{ticket.fechaCierre ? new Date(ticket.fechaCierre).toLocaleDateString() : '-'}
                    p #[strong Responsable actual:] 
                      if ticket.responsableActual && ticket.responsableActual.empleado_id
                        - const emp = ticket.responsableActual.empleado_id;
                        = `${emp.nombre} (${ticket.responsableActual.access_role})`
                      else
                        | -
                    p #[strong Proyecto:] #{ticket.proyectoRelacionado ? ticket.proyectoRelacionado.nombre : '-'}
      else
        .alert.alert-info.mb-0 No hay tickets registrados.
