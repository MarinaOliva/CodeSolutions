extends ../layouts/main

block contenido
  //- Cabecera
  .d-flex.justify-content-between.align-items-center.mb-3
    h1 Lista de Tareas
    
    //- Botón Crear Tarea (solo para gerente_admin y jefe_proyecto)
    if usuario && ['gerente_admin', 'jefe_proyecto'].includes(usuario.rol)
      a.btn.btn-success(href="/tareas/crear") + Crear Tarea

  .card.shadow-sm
    .card-body
      if tareas && tareas.length > 0
        .table-responsive
          table.table.table-striped.table-hover.align-middle
            thead.table-light
              tr
                th Nombre
                th Proyecto
                th Estado
                th Horas Est.
                th Horas Reg.
                th Empleados
                th.text-end Acciones
            tbody
              each tarea in tareas
                tr
                  td= tarea.nombre
                  td= tarea.proyectoId ? tarea.proyectoId.nombre : 'No asignado'
                  td
                    if tarea.estado === 'En progreso'
                      span.badge.bg-primary= tarea.estado
                    else if tarea.estado === 'Pendiente'
                      span.badge.bg-warning.text-dark= tarea.estado
                    else if tarea.estado === 'Finalizado'
                      span.badge.bg-success= tarea.estado
                    else
                      span.badge.bg-secondary= tarea.estado
                  td= tarea.horasEstimadas
                  td= tarea.horasRegistradas
                  td
                    if tarea.empleadosAsignados && tarea.empleadosAsignados.length > 0
                      small= tarea.empleadosAsignados.map(e => `${e.nombre} (${e.rol})`).join(', ')
                    else
                      small.text-muted No asignado
                  
                  //- Logica de permisos para botones Editar y Eliminar
                  td.text-end
                    - let puedeEditar = false
                    - let puedeEliminar = false

                    if usuario
                     
                      - const rolesEdicion = ['gerente_admin', 'jefe_proyecto']
                      - const rolesEliminar = ['gerente_admin', 'jefe_proyecto']
                    
                      - if (rolesEdicion.includes(usuario.rol)) puedeEditar = true
                      - if (rolesEliminar.includes(usuario.rol)) puedeEliminar = true
                      
                      - if (usuario.rol === 'desarrollador')
                        - const esSuTarea = tarea.empleadosAsignados && tarea.empleadosAsignados.some(e => e._id.toString() === usuario.empleadoId)
                        - if (esSuTarea) puedeEditar = true
                    //- No mostrar botones en tareas eliminadas/finalizadas
                    if tarea.estado !== 'Eliminada' && tarea.estado !== 'Finalizado' && (puedeEditar || puedeEliminar)
                      .btn-group(role="group")
                        if puedeEditar
                          a.btn.btn-sm.btn-outline-warning(href=`/tareas/editar/${tarea._id}`) Editar
                        
                        if puedeEliminar
                          form(action=`/tareas/eliminar/${tarea._id}?_method=DELETE`, method="POST", style="display:inline")
                            button.btn.btn-sm.btn-outline-danger(type="submit", onclick="return confirm('¿Seguro que quieres eliminar esta tarea?')") Eliminar
                    
                    else if tarea.estado === 'Eliminada' || tarea.estado === 'Finalizado'
                      span.text-muted --
      else
        .alert.alert-info.mb-0 No hay tareas registradas.